###########################
# Asari On-Action Events #
###########################

### Key: TGGS = T(type) G(group) S(subgroup)

namespace = mec_asari_setup

### Hidden Game Start Event
### This alters the starting conditions based on civics 

# Biotic Evolution - add Psionic Theory
#country_event = {
#	id = mec_asari_setup.101
#	hide_window = yes
#	is_triggered_only = yes

#	immediate = {
#		if = { limit = { has_civic = mec_asari_civic_biotic_evo } 
#			give_technology = { message = no tech = tech_psionic_theory }
#		}
#	}
#}

### This genderlocks all species identified as asari, which should in theory allow us to phase out mec_asari_leader.101
### Tentatively implemented in 8.1.0 - pending live testing

event = {
	id = mec_asari_setup.101
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		every_country = {
			every_owned_species = {
				limit = {
					has_trait = mec_asari_trait_core
				}
				change_species_characteristics = {
					gender = female
					can_change_leader = yes
				}
			}
		}
	}
}

### This populates the origin capitals with the appropriate districts and buildings

planet_event = {
	id = mec_asari_setup.201
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		if = {
			limit = { 
				has_planet_flag = mec_asari_planet_illium
				owner = { has_origin = mec_asari_origin_illium }
			}
			mec_asari_generate_illium_deposits = yes
			mec_asari_setup_origin_homeworld = yes
			generate_start_pops = yes
		}
		else_if = {
			limit = { 
				has_planet_flag = mec_asari_planet_thessia
				owner = { has_origin = mec_asari_origin_thessia }
			}
			mec_asari_generate_thessia_deposits = yes
			mec_asari_setup_origin_homeworld = yes
			generate_start_pops = yes
		}
	}
}

### This event merges all prescripted asari species and sets Thessia as their homeworld if available.
### Designed to be extensible to account for Omega and possibly other prescripted factions in the future.
### Does not currently support player-designed asari empires as that was causing a lot of issues.

### NOTE TO SELF: Hi future me!
### One day you will look at this and wonder what this script does and why you went to so much trouble to do something that literally doesn't matter in any practical way.
### But trust me, it matters to you! Multiple asari countries spawning their own sub-species poked so painfully at your OCD that you dropped everything else just to make the species list pretty.
### Always remember: there's nothing wrong with you, it's the rest of the universe that refuses to be perfect and it's your job to fix it, one nitpick at a time.

country_event = {
    id = mec_asari_setup.301
    hide_window = yes
    #fire_only_once = yes
	is_triggered_only = yes
	
    immediate = {
		# If any "canon" asari planets exist, save their owners
		random_country = {
			limit = {
				has_origin = mec_asari_origin_thessia
			}
			save_event_target_as = mec_asari_thessia_country
			species = { save_event_target_as = mec_asari_thessia_species }
		}
		random_country = {
			limit = {
				has_origin = mec_asari_origin_illium
			}
			save_event_target_as = mec_asari_illium_country
			species = { save_event_target_as = mec_asari_illium_species }
		}
		# Check for the first "canon" asari species generated by the game.
		# This is to make sure it's folded into the main species on the list instead of being shown in the drop-down.
		every_country = {
			limit = {
				OR = {
					is_same_value = event_target:mec_asari_thessia_country
					is_same_value = event_target:mec_asari_illium_country
				}
			}
			if = {
				limit = {
					NOT = { exists = event_target:mec_asari_main_country }
				}
				save_global_event_target_as = mec_asari_main_country
				species = { save_global_event_target_as = mec_asari_main_species }
				# If Thessia exists, set it as the main asari species homeworld
				if = {
					limit = {
						exists = event_target:mec_asari_planet_thessia
					}
					event_target:mec_asari_main_species = {
						set_species_homeworld = event_target:mec_asari_planet_thessia
					}
				}
			}
		}
		# Check for duplicate asari offshots and merge them all into one species
		every_country = {
			if = {
				limit = {
					exists = event_target:mec_asari_main_country
					OR = {
						species = { is_same_value = event_target:mec_asari_thessia_species }
						species = { is_same_value = event_target:mec_asari_illium_species }
					}
				}
				change_dominant_species = {
					species = event_target:mec_asari_main_species
					change_all = yes
				}
			}
		}
    }
}

country_event = {
    id = mec_asari_setup.302
    hide_window = yes
    #fire_only_once = yes
	is_triggered_only = yes
	
	immediate = {
		# Silently establish contact between Thessia and Illium if both exist
		If = {
			Limit = {
				exists = event_target:mec_asari_thessia_country
				exists = event_target:mec_asari_illium_country
				event_target:mec_asari_thessia_country = {
					NOT = { has_established_contact = event_target:mec_asari_illium_country }
				}
			}
			event_target:mec_asari_thessia_country = { establish_communications_no_message = event_target:mec_asari_illium_country }
		}
	}
}

### A more robust version that accounts for player-made asari empires.
### Currently unused due to problematic interactions.

#		every_country = {
#			species = { save_event_target_as = mec_asari_current_species }
#			if = {
#				limit = {
#					exists = event_target:mec_asari_main_country
#					species = { is_same_species = event_target:mec_asari_main_species }
#					event_target:mec_asari_planet_thessia = {
#						habitability = {
#							who = event_target:mec_asari_current_species
#							value >= 0.6
#						}
#					}
#				}
#				change_dominant_species = {
#					species = event_target:mec_asari_main_species
#					change_all = yes
#				}
#			}
#		}

event = {
    id = mec_asari_setup.401
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		every_galaxy_planet = {
			if = {
				limit = {
					has_owner = yes
					owner = {
						is_ai = yes
					}
					has_planet_flag = mec_asari_planet_tarith
				}
				
				set_name = "Tarith"
			}
			else_if = {
				limit = {
					has_owner = yes
					owner = {
						is_ai = yes
					}
					has_planet_flag = mec_asari_planet_helyme
				}
				
				set_name = "Helyme"
			}
			else_if = {
				limit = {
					has_owner = yes
					owner = {
						is_ai = yes
					}
					has_planet_flag = mec_asari_planet_epho
				}
				
				set_name = "Epho"
			}
			else_if = {
				limit = {
					has_owner = yes
					owner = {
						is_ai = yes
					}
					has_planet_flag = mec_asari_planet_sanves
				}
				
				set_name = "Sanves"
			}
			else_if = {
				limit = {
					has_owner = yes
					owner = {
						is_ai = yes
					}
					has_planet_flag = mec_asari_planet_niacal
				}
				
				set_name = "Niacal"
			}
			else_if = {
				limit = {
					has_owner = yes
					owner = {
						is_ai = yes
					}
					has_planet_flag = mec_asari_planet_lusia
				}
				
				set_name = "Lusia"
			}
		}
	}
}

# Choose whether to spawn Thessia if only Illium exists
country_event = {
    id = mec_asari_setup.501
	title = mec_asari_setup.501.name
	desc = mec_asari_setup.501.desc
	picture = GFX_mec_event_thessia_05

	fire_only_once = yes
	is_triggered_only = yes

	trigger = {
		has_origin = mec_asari_origin_illium
		any_system = {
			has_star_flag = mec_asari_parnitha_system
		}
		NOT = {
			any_country = {
				has_origin = mec_asari_origin_thessia
			}
		}
	}
	
	immediate = {
		save_event_target_as = mec_asari_setup_spawner
		random_system = {
			limit = { has_star_flag = mec_asari_parnitha_system }
			save_event_target_as = mec_asari_setup_system
		}
	}

	option = {
		name = mec_asari_setup.501.a
		hidden_effect = {
			country_event = { id = mec_asari_setup.511 }
		}
		ai_chance = {
			factor = 0
		}
	}

	option = {
		name = mec_asari_setup.501.b
		hidden_effect = {
			country_event = { id = mec_asari_setup.511 }
			country_event = { id = mec_asari_setup.512 days = 4 }
		}
		ai_chance = {
			factor = 0
		}
	}

	option = {
		name = mec_asari_setup.501.z
		hidden_effect = {
			clear_uncharted_space = event_target:mec_asari_setup_system
		}
	}

	after = {
	}
}

# Choose whether to spawn Illium if only Thessia exists
country_event = {
    id = mec_asari_setup.502
	title = mec_asari_setup.502.name
	desc = mec_asari_setup.502.desc
	picture = GFX_mec_event_illium_01

	fire_only_once = yes
	is_triggered_only = yes

	trigger = {
		host_has_dlc = Megacorp
		has_origin = mec_asari_origin_thessia
		any_system = {
			has_star_flag = mec_asari_tasale_system
		}
		NOT = {
			any_country = {
				has_origin = mec_asari_origin_illium
			}
		}
	}
	
	immediate = {
		save_event_target_as = mec_asari_setup_spawner
		random_system = {
			limit = { has_star_flag = mec_asari_tasale_system }
			save_event_target_as = mec_asari_setup_system
		}
	}

	option = {
		name = mec_asari_setup.502.a
		hidden_effect = {
			country_event = { id = mec_asari_setup.521 }
		}
		ai_chance = {
			factor = 0
		}
	}

	option = {
		name = mec_asari_setup.502.z
		hidden_effect = {
			clear_uncharted_space = event_target:mec_asari_setup_system
		}
	}

	after = {
	}
}

# Spawn ASR as a regular empire
country_event = {
    id = mec_asari_setup.511
    hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		random_galaxy_planet = {
			limit = { has_planet_flag = mec_asari_planet_thessia }
			clear_planet_modifiers = yes
			create_country = {
				species = event_target:mec_asari_setup_spawner
				name_list = event_target:mec_asari_setup_spawner
				type = default
				authority = auth_democratic
				ethos = {
					ethic = ethic_fanatic_xenophile
					ethic = ethic_egalitarian
				}
				civics = {
					civic = mec_asari_civic_thessia
					civic = civic_diplomatic_corps
				}
				origin = "mec_asari_origin_thessia"
				flag = {
					icon = {
						category = "mec_asari_civ"
						file = "mec_asari_thessia_flag.dds"
					}
					background = {
						category = "backgrounds"
						file = "00_solid.dds"
					}
					colors = {
						"indigo"
						"indigo"
						"null"
						"null"
					}
				}
				effect = {
					save_event_target_as = mec_asari_setup_spawnee
					set_country_flag = mec_asari_asr
					set_country_flag = custom_start_screen
					set_country_flag = first_contact_event
					set_country_flag = first_alien_life
					set_country_flag = first_colony
					set_country_flag = Story5
				}
			}
			create_colony = {
				owner = event_target:mec_asari_setup_spawnee
			}
			mec_asari_generate_thessia_deposits = yes
			mec_asari_setup_origin_homeworld = yes
			generate_start_pops = yes
			set_name = "Thessia"
			set_owner = event_target:mec_asari_setup_spawnee
			set_capital = yes
			solar_system = {
				create_starbase = {
					size = starbase_starport
					module = shipyard
					module = trading_hub
					building = crew_quarters
					owner = event_target:mec_asari_setup_spawnee
				}
			}
			event_target:mec_asari_setup_spawnee = {
				create_starting_leaders = yes
				country_event = { id = game_start.8 }
				country_event = { id = game_start.9 }
				country_event = { id = game_start.33 days = 2 } # needs delay for system ownership to settle
				country_event = { id = mec_asari_asr.102 days = 2 }
				set_name = "mec_asari_republics"
				establish_communications_no_message = event_target:mec_asari_setup_spawner
			}
		}
	}
}

# Spawn ASR as an advanced empire
country_event = {
    id = mec_asari_setup.512
    hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		if = {
			limit = {
				exists = event_target:mec_asari_setup_spawnee
			}
			event_target:mec_asari_setup_spawnee = {
				capital_scope = {
					clear_blockers = yes
					mec_asari_generate_advanced_thessia = yes
				}
				country_event = { id = game_start.6 }
			}
		}
	}
}

# Spawn ASI as a regular empire
country_event = {
    id = mec_asari_setup.521
    hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		random_galaxy_planet = {
			limit = { has_planet_flag = mec_asari_planet_illium }
			clear_planet_modifiers = yes
			change_pc = pc_mec_illium
			create_country = {
				species = event_target:mec_asari_setup_spawner
				name_list = event_target:mec_asari_setup_spawner
				type = default
				authority = auth_corporate
				ethos = {
					ethic = "ethic_authoritarian"
					ethic = "ethic_xenophile"
					ethic = "ethic_materialist"
				}
				civics = {
					civic = mec_asari_civic_illium
					civic = civic_indentured_assets
				}
				origin = "mec_asari_origin_illium"
				flag = {
					icon = {
						category = "mec_asari_civ"
						file = "mec_asari_illium_flag.dds"
					}
					background = {
						category = "backgrounds"
						file = "pattern_01.dds"
					}
					colors = {
						"dark_purple"
						"black"
						"null"
						"null"
					}
				}
				effect = {
					save_event_target_as = mec_asari_setup_spawnee
					set_country_flag = mec_asari_asi
					set_country_flag = custom_start_screen
					set_country_flag = first_contact_event
					set_country_flag = first_alien_life
					set_country_flag = first_colony
					set_country_flag = Story5
				}
			}
			create_colony = {
				owner = event_target:mec_asari_setup_spawnee
			}
			mec_asari_generate_illium_deposits = yes
			mec_asari_setup_origin_homeworld = yes
			generate_start_pops = yes
			set_name = "Illium"
			set_owner = event_target:mec_asari_setup_spawnee
			set_capital = yes
			solar_system = {
				create_starbase = {
					size = starbase_starport
					module = shipyard
					module = trading_hub
					building = crew_quarters
					owner = event_target:mec_asari_setup_spawnee
				}
			}
			event_target:mec_asari_setup_spawnee = {
				create_starting_leaders = yes
				country_event = { id = game_start.8 }
				country_event = { id = game_start.9 }
				country_event = { id = game_start.33 days = 2 } # needs delay for system ownership to settle
				country_event = { id = mec_asari_asi.101 }
				country_event = { id = mec_asari_asi.102 days = 2 }
				set_name = "mec_asari_corporate_interests"
				establish_communications_no_message = event_target:mec_asari_setup_spawner
			}
		}
	}
}